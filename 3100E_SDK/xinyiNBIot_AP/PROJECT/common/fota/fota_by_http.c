/**
* @file      fota_by_http.c
* @brief 	 该源文件仅适用于http搭建的私有云FOTA服务器的升级操控，即AP核通过扩展AT命令，触发CP核执行http的远程差分包下载、升级动作。
* @warning   由于私有云开发周期长，请客户使用时务必先跟芯翼研发交流清楚，否则无法支持！
*/

#include "xy_printf.h"
#include <stdio.h>
#include "at_process.h"
#include "cloud_process.h"
#include "err_process.h"


//HTTP 下载差分包的超时时间，1800S
#define HTTPFOAT_DOWNLOAD_TIMEOUT 1800

//http fota url配置信息，用户可设
#define HTTP_FOTA_URL_CONFIG  "AT+HTTPFOTA=1,\"http://139.224.131.190:3000/users/g\"\r\n"

//server cert 配置信息，用户可设
#define SERVER_CERT_CONFIG    "AT+HTTPFOTA=0,2D2D2D2D2D424547494E2043455254494649434154452D2D2D2D2D0D0A4D494945716A434341354B674177494241674951416E6D7352597642736B57722B5942547A5379627354414E42676B71686B69473977304241517346414442680D0A4D517377435159445651514745774A56557A45564D424D474131554543684D4D52476C6E61554E6C636E51675357356A4D526B77467759445651514C457842330D0A643363755A476C6E61574E6C636E5175593239744D5341774867594456515144457864456157647051325679644342486247396959577767556D3976644342440D0A51544165467730784E7A45784D6A63784D6A51324D544261467730794E7A45784D6A63784D6A51324D5442614D473478437A414A42674E5642415954416C56540D0A4D525577457759445651514B4577784561576470513256796443424A626D4D784754415842674E5642417354454864336479356B61576470593256796443356A0D0A623230784C54417242674E5642414D544A45567559334A35634852706232346752585A6C636E6C33614756795A5342455669425554464D67513045674C5342480D0A4D544343415349774451594A4B6F5A496876634E4151454242514144676745504144434341516F4367674542414C50655036776B6162343164795168366D4B630D0A6F487174336A52497857354D447666395179694F5237566646774B363536657330554669496237344E3970526E747A46315567597A4447753370705A564D646F0D0A6C6278686D36645753394F4B2F6C4665684B4E54304F59493961716B36462B55376341366A7853432B6944425058776446347273334B5279703361516E36706A0D0A70703179723749423659347A76373245652F506C5A2F36724B36496E433657704B306E50564F5952376E3969447550653145344978554D42482F5433332B33680D0A79754833647666676957554F556B6A64704D627978582B584E6C6535754549697942736934497662635443683872756966434969356D44586B5A726E4D54386E0D0A77665943563676366B4464586B626747524C4B735234707563624A74624B71496B554778755A49327437706665774B5263356E5765637644425A66332B70314D0D0A704138434177454141614F43415538776767464C4D42304741315564446751574242525664452B79636B2F31594C70513064666D5556796141596361317A41660D0A42674E5648534D454744415767425144336C41315674464D753262776F2B496247384F58736A33525654414F42674E56485138424166384542414D43415959770D0A485159445652306C42425977464159494B7759424251554841774547434373474151554642774D434D42494741315564457745422F7751494D415942416638430D0A415141774E4159494B77594242515548415145454B44416D4D4351474343734741515546427A41426868686F644852774F69387662324E7A6343356B615764700D0A593256796443356A623230775167594456523066424473774F5441336F4457674D3459786148523063446F764C324E7962444D755A476C6E61574E6C636E51750D0A593239744C3052705A326C445A584A3052327876596D4673556D397664454E424C6D4E796244424D42674E5648534145525442444D44634743574347534147470D0A2F577742416A41714D4367474343734741515546427749424668786F64485277637A6F764C3364336479356B61576470593256796443356A62323076513142540D0A4D416747426D6542444145434154414E42676B71686B6947397730424151734641414F43415145414B334770362F6147713761425A7378662F6F512B54442F420D0A5377573341553445544B2B475166326B467A595A6B6279355346724864506F6D756E783248427A5669556368476F6F66476767376748573057334D6C514158570D0A4D3072354C5576537463723832514457594E5061557934746143516D79614A2B56422B3677784873745369674F6C534E463261367667347267657869786569560D0A34595342303359717032743354655A484D394553666B757337346E51795737705247657A6A2B54433434784361674351514F7A7A4E6D7A45415032536E43724A0D0A734E4532447052564D6E4C384A36784252646A6D4F7343334E366351754B755258627A427956426A437141413874314C30492B3977584A65724C507945726A790D0A724D4B576142464C6D664B2F41484E46345A69687750474F633777365548637A425A58483552467A4A4E6E77772B576E4B755450493048666E5648386C673D3D0D0A2D2D2D2D2D454E442043455254494649434154452D2D2D2D2D\r\n"

/**
 * @brief 用户发送AT命令
 */
void xy_Fota_By_Http(void)
{
	At_status_type at_ret = XY_OK;

	//第0步：查询升级结果，没有升级才会执行下载升级
	at_ret = AT_Send_And_Get_Rsp("AT+HTTPFOTA=4\r\n", AT_RESPONSE_TIMEOUT, "+HTTPFOTA:NO UPDATE RESULT\r\n", NULL);
	if(User_Err_Process(at_ret))
		return;

	//第1步：查询PDP是否激活
	if(xy_wait_tcpip_ok(60) != XY_OK)
		return;

	//第2步：设置服务器证书
	/*at_ret = AT_Send_And_Get_Rsp(SERVER_CERT_CONFIG,AT_RESPONSE_TIMEOUT, NULL,NULL);
	if(User_Err_Process(at_ret))
		return;*/

	//第3步：设置服务器URL
	at_ret = AT_Send_And_Get_Rsp(HTTP_FOTA_URL_CONFIG, AT_RESPONSE_TIMEOUT, NULL, NULL );
	if(User_Err_Process(at_ret))
		return;

	//第4步：下载差分包
	at_ret = AT_Send_And_Get_Rsp("AT+HTTPFOTA=2\r\n", HTTPFOAT_DOWNLOAD_TIMEOUT, "+HTTPFOTA:DOWNLOAD SUCCESS\r\n", NULL);
	if(User_Err_Process(at_ret))
		return;

	//第5步：校验差分包并升级
	at_ret = AT_Send_And_Get_Rsp("AT+HTTPFOTA=3\r\n", AT_RESPONSE_TIMEOUT, NULL, NULL);
	if(User_Err_Process(at_ret))
		return;
}


